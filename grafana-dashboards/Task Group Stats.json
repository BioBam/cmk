{
  "__inputs": [
    {
      "name": "DS_AMAZONTIMESTREAM",
      "label": "AmazonTimestream",
      "description": "",
      "type": "datasource",
      "pluginId": "grafana-timestream-datasource",
      "pluginName": "Amazon Timestream"
    }
  ],
  "__elements": {},
  "__requires": [
    {
      "type": "panel",
      "id": "bargauge",
      "name": "Bar gauge",
      "version": ""
    },
    {
      "type": "grafana",
      "id": "grafana",
      "name": "Grafana",
      "version": "10.4.0-65875"
    },
    {
      "type": "datasource",
      "id": "grafana-timestream-datasource",
      "name": "Amazon Timestream",
      "version": "2.3.0"
    },
    {
      "type": "panel",
      "id": "stat",
      "name": "Stat",
      "version": ""
    },
    {
      "type": "panel",
      "id": "table",
      "name": "Table",
      "version": ""
    },
    {
      "type": "panel",
      "id": "text",
      "name": "Text",
      "version": ""
    },
    {
      "type": "panel",
      "id": "timeseries",
      "name": "Time series",
      "version": ""
    }
  ],
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "target": {
          "limit": 100,
          "matchAny": false,
          "tags": [],
          "type": "dashboard"
        },
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 2,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 35,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "<br>\n<h2><center> Duration Analysis </center> </h2>",
        "mode": "html"
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "blue",
            "mode": "fixed"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "series",
            "axisLabel": "Duration",
            "axisPlacement": "left",
            "barAlignment": 0,
            "drawStyle": "bars",
            "fillOpacity": 100,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "ms",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/max_duration.*/"
            },
            "properties": [
              {
                "id": "custom.fillBelowTo",
                "value": "min_duration"
              },
              {
                "id": "custom.lineWidth",
                "value": 0
              },
              {
                "id": "custom.showPoints",
                "value": "never"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "min_duration"
            },
            "properties": [
              {
                "id": "custom.lineWidth",
                "value": 1
              },
              {
                "id": "custom.showPoints",
                "value": "never"
              }
            ]
          },
          {
            "matcher": {
              "id": "byRegexp",
              "options": "/task_rate.*/"
            },
            "properties": [
              {
                "id": "custom.drawStyle",
                "value": "line"
              },
              {
                "id": "custom.axisPlacement",
                "value": "right"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#24292e",
                  "mode": "fixed"
                }
              },
              {
                "id": "unit",
                "value": "none"
              },
              {
                "id": "custom.axisLabel",
                "value": "Task count"
              },
              {
                "id": "custom.fillOpacity",
                "value": 1
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 7,
        "w": 16,
        "x": 0,
        "y": 2
      },
      "id": 16,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "9.1.6-10b38e80",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "cpuAssignedCount",
          "rawQuery": "SELECT  BIN(time,$interval)                                                      AS binned_timestamp\n       ,\"$label\"\n\t,COALESCE( MAX(measure_value::bigint),MAX(measure_value::double) ) AS max_duration\n       ,COALESCE( MIN(measure_value::bigint),MIN(measure_value::double) ) AS min_duration\n       ,COALESCE( AVG(measure_value::bigint),AVG(measure_value::double) ) AS avg_duration\n       ,measure_name, count() as task_rate_bin_$interval\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE \"$label\" = '$val' AND measure_name='durationMs' and $__timeFilter\nGROUP BY measure_name, \"$label\", BIN(time,$interval)\nORDER BY binned_timestamp ASC\n",
          "refId": "B",
          "table": "\"aggregated_metrics\""
        }
      ],
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-blues"
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "ms",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "count"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Tasks Count"
              },
              {
                "id": "unit",
                "value": "none"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "transparent",
                  "mode": "continuous-greens"
                }
              },
              {
                "id": "max",
                "value": 1000
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "window"
            },
            "properties": [
              {
                "id": "unit",
                "value": "s"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "transparent",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Search Window"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "sumWallTimes"
            },
            "properties": [
              {
                "id": "unit",
                "value": "s"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "transparent",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Σ Task Wall Times"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 9,
        "w": 5,
        "x": 17,
        "y": 2
      },
      "id": 40,
      "options": {
        "colorMode": "background_solid",
        "graphMode": "area",
        "justifyMode": "center",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": true
        },
        "showPercentChange": false,
        "text": {
          "valueSize": 30
        },
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "cpuAssignedCount",
          "rawQuery": "SELECT \n       date_diff('second', from_milliseconds($__from), from_milliseconds($__to) ) as window\n       ,count() as count\n       ,SUM(measure_value::bigint)/1000 AS sumWallTimes\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE \"$label\" = '$val' AND measure_name='durationMs' AND $__timeFilter\n",
          "refId": "A",
          "table": "\"aggregated_metrics\""
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-blues"
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "ms",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "count"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Tasks Count"
              },
              {
                "id": "unit",
                "value": "none"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "window"
            },
            "properties": [
              {
                "id": "unit",
                "value": "s"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "transparent",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Measuring Window"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "sumWallTimes"
            },
            "properties": [
              {
                "id": "unit",
                "value": "s"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "transparent",
                  "mode": "fixed"
                }
              },
              {
                "id": "displayName",
                "value": "Σ Wall Times"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "avg"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Average"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 2,
        "w": 16,
        "x": 0,
        "y": 9
      },
      "id": 3,
      "options": {
        "colorMode": "background",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": true
        },
        "showPercentChange": false,
        "text": {
          "valueSize": 30
        },
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "cpuAssignedCount",
          "rawQuery": "SELECT \n       MIN(measure_value::bigint) AS Shortest\n       ,AVG(measure_value::bigint) as avg\n       -- ,APPROX_PERCENTILE(measure_value::bigint, 0.05) AS p25\n       ,APPROX_PERCENTILE(measure_value::bigint, 0.75) AS p75\n       ,APPROX_PERCENTILE(measure_value::bigint, 0.95) AS p95\n       ,MAX(measure_value::bigint) AS Longest\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE \"$label\" = '$val' AND measure_name='durationMs' AND $__timeFilter\n\n",
          "refId": "B",
          "table": "\"aggregated_metrics\""
        }
      ],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 4,
        "w": 24,
        "x": 0,
        "y": 11
      },
      "id": 36,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "<br>\n<h2><center> CPU Analysis </center> </h2>\n\nThe CPU Analysis chart shows the maximum and average percentage of CPU used by the tasks in each bin.\nA value closer to the \"Detected Assigned Task CPU\" is better.\nEnsure optimal CPU allocation by comparing assigned, maximum, and average values.\nConsider reducing the CPU assigned for tasks if the peak and average values are consistently under the CPU limit.\nIf the chart shows peaks above the limit, the tasks might be using more CPUs than assigned if available in the VM.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 3,
        "w": 12,
        "x": 0,
        "y": 15
      },
      "id": 42,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "- Detected Assigned Task CPU: The existing CPU allocation per task, adjustable based on task configurations.\n- Avg of Peaks (Recommended CPUs) - This is the mean of all the maximum CPU values in all the tasks in the selected time window.\n",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 3,
        "w": 12,
        "x": 12,
        "y": 15
      },
      "id": 41,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "- Max CPUs Peak - The maximum CPU usage detected in this time.\n- Maximum Average CPUs: The maximum measured CPU average among the tasks. This is the CPU value the tasks would need if the CPU usage were constant.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "green",
            "mode": "fixed",
            "seriesBy": "last"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "bars",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 0,
            "pointSize": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "line+area"
            }
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "transparent",
                "value": null
              }
            ]
          },
          "unit": "none",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "assigned"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    10,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "custom.lineWidth",
                "value": 2
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#232323",
                  "mode": "fixed"
                }
              },
              {
                "id": "custom.drawStyle",
                "value": "bars"
              },
              {
                "id": "displayName",
                "value": "Detected CPU Limit"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "maxUse"
            },
            "properties": [
              {
                "id": "custom.fillOpacity",
                "value": 81
              },
              {
                "id": "displayName",
                "value": "Max CPUs Peak"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "light-yellow",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "avgUse"
            },
            "properties": [
              {
                "id": "custom.fillOpacity",
                "value": 100
              },
              {
                "id": "displayName",
                "value": "Average CPU"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 16,
        "x": 0,
        "y": 18
      },
      "id": 18,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "9.1.6-10b38e80",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "available",
          "rawQuery": "SELECT\n    binned_timestamp\n    ,maxCpuMaxPercentage/100  AS maxUse\n    ,CAST(sumCpuTimeUsed AS DOUBLE PRECISION) / NULLIF(sumCpuTimeReserved, 0) * cpuAssignedCount AS avgUse \n    ,cpuAssignedCount as assigned\nFROM \n    (SELECT \n        BIN(time, $interval) AS binned_timestamp,\n        MAX(CASE WHEN measure_name = 'cpuMaxPercentage' THEN measure_value::double END) AS maxCpuMaxPercentage,\n        MAX(CASE WHEN measure_name = 'cpuAssignedCount' THEN measure_value::bigint END) AS cpuAssignedCount,\n        SUM(CASE WHEN measure_name = 'cpuTimeUsed' THEN measure_value::bigint ELSE 0 END) AS sumCpuTimeUsed,\n        SUM(CASE WHEN measure_name = 'cpuTimeReserved' THEN measure_value::bigint ELSE 0 END) AS sumCpuTimeReserved\n    FROM \n        \"metricsDB\".\"aggregated_metrics\"\n    WHERE \n        \"$label\" = '$val' AND \n        measure_name IN ('cpuTimeUsed', 'cpuTimeReserved', 'cpuMaxPercentage', 'cpuAssignedCount') AND \n        $__timeFilter \n    GROUP BY \n        BIN(time, $interval)\n    ) AS aggregated_data\nORDER BY \n    binned_timestamp ASC\n",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transformations": [],
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "Σ CPU Time Reserved=amount of cores reserved multiplied by the duration of the task.\nΣ CPU Time Used=The CPU time used by all the tasks\nΣ CPU Time Waste=The remaining time that the CPUs were reserved for this task but were not used 100%.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-RdYlGr"
          },
          "mappings": [],
          "max": 1,
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "ns",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "SumDurationMs"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "Σ Wall Times"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SumCpuTimeUsed"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Σ CPU Time Used"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SumCpuReserved"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Σ CPU Time Reserved"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "SumCpuTimeWaste"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Σ CPU Time Waste"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 2,
        "x": 16,
        "y": 18
      },
      "id": 39,
      "options": {
        "colorMode": "background_solid",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": true
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "available",
          "rawQuery": "SELECT \n       -- SUM(if(measure_name='durationMs', measure_value::bigint)) AS SumDurationMs\n       SUM(if(measure_name='cpuTimeReserved', measure_value::bigint)) AS SumCpuReserved\n       ,SUM(if(measure_name='cpuTimeUsed', measure_value::bigint)) AS SumCpuTimeUsed\n       ,SUM(if(measure_name='cpuTimeUsed', measure_value::bigint))-SUM(if(measure_name='cpuTimeReserved', measure_value::bigint)) AS SumCpuTimeWaste\n       FROM \"metricsDB\".\"aggregated_metrics\"\n       WHERE \"$label\" = '$val' AND ( measure_name='cpuTimeUsed' OR measure_name='cpuTimeReserved' OR measure_name='durationMs') and $__timeFilter\n       GROUP BY \"$label\"\n       \n-- [ \"memoryAvg\", \"memoryMax\", \"memoryLimit\", \"cpuTimeThrottled\", \"cpuAvgPercentage\", \"cpuMaxPercentage\", \"durationMs\", \"cpuAssignedCount\", \"cpuTimeReserved\", \"cpuTimeUsed\" ]\n",
          "refId": "B",
          "table": "\"mem\""
        }
      ],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-YlBl"
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "none",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "max_average"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Maximum Average CPUs"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "max"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Max CPUs Peak"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "max_assigned"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Detected CPU Limit"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#696969",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "avg"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Avg of Peaks (Recommended CPUs)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 7,
        "w": 6,
        "x": 18,
        "y": 18
      },
      "id": 21,
      "options": {
        "displayMode": "gradient",
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "10.4.0-65875",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "available",
          "rawQuery": "SELECT \n       MAX(if(measure_name='cpuAssignedCount', measure_value::bigint)) as max_assigned\n       ,AVG(if(measure_name='cpuMaxPercentage', measure_value::double))/100 AS avg\n       ,MAX(if(measure_name='cpuMaxPercentage', measure_value::double))/100 AS max\n       ,MAX(if(measure_name='cpuAvgPercentage', measure_value::double))/100 AS max_average\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE \"$label\" = '$val' AND ( measure_name='cpuAvgPercentage' OR measure_name='cpuMaxPercentage' OR measure_name='cpuAssignedCount') and $__timeFilter\nGROUP BY \"$label\"\n",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 3,
        "w": 24,
        "x": 0,
        "y": 26
      },
      "id": 37,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "<br>\n<h2><center> Memory Analysis </center> </h2>\n\nProvides memory allocation recommendations based on the maximum memory values utilized by tasks. Use this to prevent \"OutOfMemory\" errors and optimize resource use.\n\n- Max Memory Used (Min Recommended)  - Suggests allocating memory above this value to prevent task failures and ensure stable operation. This is the peak memory usage detected in each time bin. This value does not consider memory used for cache.\n- Memory Limit (Reserved) - Represents the reserved memory detected for each bin. Only the maximum value is shown if multiple limits are found.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.0-65610",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 3,
        "w": 12,
        "x": 0,
        "y": 29
      },
      "id": 43,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "- Max Memory Used (Min Recommended)  - Suggests allocating memory above this value to prevent task failures and ensure stable operation. This is the peak memory usage detected in each time bin. This value does not consider memory used for cache.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.0-65610",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 2,
        "w": 12,
        "x": 12,
        "y": 29
      },
      "id": 44,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "- Memory Limit (Reserved) - Represents the reserved memory detected for each bin. Only the maximum value is shown if multiple limits are found.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.0-65610",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "#E02F44",
            "mode": "continuous-BlPu"
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "bytes",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "max"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Max Memory Used - (Min Recommended)"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "limit"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Memory Limit (Max Reserved)"
              },
              {
                "id": "color",
                "value": {
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 17,
        "y": 31
      },
      "id": 22,
      "options": {
        "displayMode": "gradient",
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "10.4.0-65610",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "available",
          "rawQuery": "SELECT \n       MAX(if(measure_name='memoryLimit', measure_value::bigint)) AS limit\n       ,MAX(if(measure_name='memoryMax', measure_value::bigint)) AS max\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE \"$label\" = '$val' AND ( measure_name='memoryLimit' OR measure_name='memoryMax') and $__timeFilter\nGROUP BY \"$label\"",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "fixedColor": "super-light-blue",
            "mode": "fixed",
            "seriesBy": "max"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "bars",
            "fillOpacity": 100,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "min": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "bytes",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "peak"
            },
            "properties": [
              {
                "id": "custom.fillOpacity",
                "value": 100
              },
              {
                "id": "custom.pointSize",
                "value": 1
              },
              {
                "id": "custom.lineWidth",
                "value": 0
              },
              {
                "id": "displayName",
                "value": "Memory Used"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "limit"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    10,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "displayName",
                "value": "Memory Limit"
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#1c1c1c",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 16,
        "x": 0,
        "y": 32
      },
      "id": 17,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "9.1.6-10b38e80",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "available",
          "rawQuery": "SELECT \n  BIN(time, $interval) AS binned_timestamp,\n  \"$label\",\n  MAX(CASE WHEN measure_name='memoryMax' THEN measure_value::bigint END) AS peak,\n  MAX(CASE WHEN measure_name='memoryLimit' THEN measure_value::bigint END) AS limit\nFROM \n  \"metricsDB\".\"aggregated_metrics\"\nWHERE \n  \"$label\" = '$val'\n  AND measure_name IN ('memoryAvg', 'memoryMax', 'memoryLimit')\n  AND $__timeFilter\nGROUP BY \n  \"$label\", \n  BIN(time, $interval)\nORDER BY \n  binned_timestamp ASC",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "gridPos": {
        "h": 2,
        "w": 24,
        "x": 0,
        "y": 40
      },
      "id": 38,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "<br>\n<h2><center> List of Tasks</center> </h2>",
        "mode": "html"
      },
      "pluginVersion": "10.4.0-65610",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "measure": "active",
          "refId": "A",
          "table": "\"mem\""
        }
      ],
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-timestream-datasource",
        "uid": "${DS_AMAZONTIMESTREAM}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "none",
          "unitScale": true
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "C_WMS (lastNotNull)"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 78
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "C_TOOL (lastNotNull)"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 164
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "C_DATASET (lastNotNull)"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 312
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "jobId"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 341
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "host (lastNotNull)"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 181
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "time (firstNotNull)"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 230
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "jobId"
            },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Task Details",
                    "url": "d/CqdB5ZSVk/task-level-stats?orgId=1&var-AWS_BATCH_JOB_ID=${__data.fields.jobId}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "stopCode"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 186
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 42
      },
      "id": 34,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true,
        "sortBy": []
      },
      "pluginVersion": "10.4.0-65610",
      "targets": [
        {
          "database": "\"metricsDB\"",
          "datasource": {
            "type": "grafana-timestream-datasource",
            "uid": "${DS_AMAZONTIMESTREAM}"
          },
          "hide": false,
          "measure": "durationMs",
          "rawQuery": "SELECT * FROM \"metricsDB\".\"aggregated_metrics\" where \"$label\" = '$val' AND $__timeFilter AND measure_name='durationMs'\n",
          "refId": "A",
          "table": "\"aggregated_metrics\""
        }
      ],
      "transformations": [],
      "transparent": true,
      "type": "table"
    }
  ],
  "refresh": "",
  "revision": 1,
  "schemaVersion": 39,
  "tags": [],
  "templating": {
    "list": [
      {
        "current": {
          "selected": false,
          "text": "AmazonTimestream",
          "value": "6U54SZIVk"
        },
        "hide": 0,
        "includeAll": false,
        "label": "Data Source",
        "multi": false,
        "name": "DATA_SOURCE",
        "options": [],
        "query": "grafana-timestream-datasource",
        "queryValue": "",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "type": "datasource"
      },
      {
        "auto": true,
        "auto_count": 30,
        "auto_min": "10s",
        "current": {
          "selected": true,
          "text": "auto",
          "value": "$__auto_interval_interval"
        },
        "description": "The size of the bins in the timeseries data.",
        "hide": 0,
        "label": "Resolution",
        "name": "interval",
        "options": [
          {
            "selected": true,
            "text": "auto",
            "value": "$__auto_interval_interval"
          },
          {
            "selected": false,
            "text": "10s",
            "value": "10s"
          },
          {
            "selected": false,
            "text": "30s",
            "value": "30s"
          },
          {
            "selected": false,
            "text": "1m",
            "value": "1m"
          },
          {
            "selected": false,
            "text": "10m",
            "value": "10m"
          },
          {
            "selected": false,
            "text": "30m",
            "value": "30m"
          },
          {
            "selected": false,
            "text": "1h",
            "value": "1h"
          },
          {
            "selected": false,
            "text": "6h",
            "value": "6h"
          },
          {
            "selected": false,
            "text": "12h",
            "value": "12h"
          },
          {
            "selected": false,
            "text": "1d",
            "value": "1d"
          },
          {
            "selected": false,
            "text": "7d",
            "value": "7d"
          },
          {
            "selected": false,
            "text": "14d",
            "value": "14d"
          },
          {
            "selected": false,
            "text": "30d",
            "value": "30d"
          }
        ],
        "query": "10s,30s,1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",
        "queryValue": "",
        "refresh": 2,
        "skipUrlSync": false,
        "type": "interval"
      },
      {
        "current": {},
        "datasource": {
          "type": "grafana-timestream-datasource",
          "uid": "${DS_AMAZONTIMESTREAM}"
        },
        "definition": "describe \"metricsDB\".\"aggregated_metrics\"",
        "description": "One of the labels associated to the metrics",
        "hide": 0,
        "includeAll": false,
        "label": "Label",
        "multi": false,
        "name": "label",
        "options": [],
        "query": "describe \"metricsDB\".\"aggregated_metrics\"",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 0,
        "type": "query"
      },
      {
        "current": {},
        "datasource": {
          "type": "grafana-timestream-datasource",
          "uid": "${DS_AMAZONTIMESTREAM}"
        },
        "definition": "SELECT DISTINCT \"$label\"\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE $__timeFilter",
        "description": "Group by the label having this value",
        "hide": 0,
        "includeAll": false,
        "label": "Value",
        "multi": false,
        "name": "val",
        "options": [],
        "query": "SELECT DISTINCT \"$label\"\nFROM \"metricsDB\".\"aggregated_metrics\"\nWHERE $__timeFilter",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 0,
        "type": "query"
      }
    ]
  },
  "time": {
    "from": "now-2d",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "Task Group Stats",
  "uid": "e92654fd-02c6-446b-bb6f-c2134780e247",
  "version": 106,
  "weekStart": ""
}